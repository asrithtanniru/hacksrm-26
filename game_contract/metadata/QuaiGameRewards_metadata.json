"{\"compiler\":{\"version\":\"0.8.20+commit.a1b79de6\"},\"language\":\"Solidity\",\"output\":{\"abi\":[{\"inputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"constructor\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"player\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"pendingUnits\",\"type\":\"uint256\"}],\"name\":\"ChallengeCompleted\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"player\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"startedAt\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"endsAt\",\"type\":\"uint256\"}],\"name\":\"ChallengeStarted\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"operator\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"bool\",\"name\":\"allowed\",\"type\":\"bool\"}],\"name\":\"GameOperatorUpdated\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"player\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"npcTalks\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"rewardPoints\",\"type\":\"uint256\"}],\"name\":\"NpcTalkRecorded\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"oldValue\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"newValue\",\"type\":\"uint256\"}],\"name\":\"RewardPerUnitUpdated\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"player\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"units\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"amount\",\"type\":\"uint256\"}],\"name\":\"RewardRedeemed\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"player\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"units\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"totalAmount\",\"type\":\"uint256\"},{\"indexed\":true,\"internalType\":\"bytes32\",\"name\":\"rewardId\",\"type\":\"bytes32\"}],\"name\":\"RewardSent\",\"type\":\"event\"},{\"inputs\":[],\"name\":\"CHALLENGE_WINDOW\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"NPCS_PER_CHALLENGE\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"NPCS_PER_POINT\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"name\":\"gameOperators\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"player\",\"type\":\"address\"}],\"name\":\"getPlayerProgress\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"challengeStartedAt\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"challengeEndsAt\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"npcTalks\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"rewardPoints\",\"type\":\"uint256\"},{\"internalType\":\"bool\",\"name\":\"completed\",\"type\":\"bool\"},{\"internalType\":\"bool\",\"name\":\"expired\",\"type\":\"bool\"},{\"internalType\":\"uint256\",\"name\":\"claimableUnits\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"owner\",\"outputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"name\":\"pendingRewardUnits\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"name\":\"playerStates\",\"outputs\":[{\"internalType\":\"uint64\",\"name\":\"challengeStartedAt\",\"type\":\"uint64\"},{\"internalType\":\"uint8\",\"name\":\"npcTalks\",\"type\":\"uint8\"},{\"internalType\":\"bool\",\"name\":\"completed\",\"type\":\"bool\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"player\",\"type\":\"address\"}],\"name\":\"recordNpcTalk\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"redeemMyRewards\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"rewardPerUnit\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"player\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"units\",\"type\":\"uint256\"},{\"internalType\":\"bytes32\",\"name\":\"rewardId\",\"type\":\"bytes32\"}],\"name\":\"rewardPlayer\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"operator\",\"type\":\"address\"},{\"internalType\":\"bool\",\"name\":\"allowed\",\"type\":\"bool\"}],\"name\":\"setGameOperator\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"newRewardPerUnit\",\"type\":\"uint256\"}],\"name\":\"setRewardPerUnit\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"startChallenge\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"player\",\"type\":\"address\"}],\"name\":\"startChallengeFor\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"bytes32\",\"name\":\"\",\"type\":\"bytes32\"}],\"name\":\"usedRewardIds\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"stateMutability\":\"payable\",\"type\":\"receive\"}],\"devdoc\":{\"kind\":\"dev\",\"methods\":{},\"version\":1},\"userdoc\":{\"kind\":\"user\",\"methods\":{},\"version\":1}},\"settings\":{\"compilationTarget\":{\"contracts/QuaiGameRewards.sol\":\"QuaiGameRewards\"},\"evmVersion\":\"london\",\"libraries\":{},\"metadata\":{\"bytecodeHash\":\"ipfs\",\"useLiteralContent\":true},\"optimizer\":{\"enabled\":true,\"runs\":1000},\"remappings\":[]},\"sources\":{\"contracts/QuaiGameRewards.sol\":{\"content\":\"// SPDX-License-Identifier: MIT\\npragma solidity ^0.8.20;\\n\\ncontract QuaiGameRewards {\\n\\n    address public owner;\\n    uint256 public rewardPerUnit = 0.1 ether;\\n\\n    uint256 public constant CHALLENGE_WINDOW = 5 minutes;\\n    uint256 public constant NPCS_PER_POINT = 3;\\n    uint256 public constant NPCS_PER_CHALLENGE = 9;\\n\\n    struct PlayerState {\\n        uint64 challengeStartedAt;\\n        uint8 npcTalks;\\n        bool completed;\\n    }\\n\\n    mapping(address => PlayerState) public playerStates;\\n    mapping(address => uint256) public pendingRewardUnits;\\n    mapping(address => bool) public gameOperators;\\n\\n    mapping(bytes32 => bool) public usedRewardIds;\\n\\n    event RewardSent(\\n        address indexed player,\\n        uint256 units,\\r\\n        uint256 totalAmount,\\n        bytes32 indexed rewardId\\n    );\\n    event ChallengeStarted(address indexed player, uint256 startedAt, uint256 endsAt);\\n    event NpcTalkRecorded(address indexed player, uint256 npcTalks, uint256 rewardPoints);\\n    event ChallengeCompleted(address indexed player, uint256 pendingUnits);\\n    event RewardRedeemed(address indexed player, uint256 units, uint256 amount);\\n    event GameOperatorUpdated(address indexed operator, bool allowed);\\n    event RewardPerUnitUpdated(uint256 oldValue, uint256 newValue);\\n\\n    constructor() {\\n        owner = msg.sender;\\n        gameOperators[msg.sender] = true;\\n    }\\n\\n    receive() external payable {}\\n\\n    modifier onlyOwner() {\\n        require(msg.sender == owner, \\\"Not authorized\\\");\\n        _;\\n    }\\n\\n    modifier onlyOperator() {\\n        require(gameOperators[msg.sender], \\\"Not operator\\\");\\n        _;\\n    }\\n\\n    function setGameOperator(address operator, bool allowed) external onlyOwner {\\n        require(operator != address(0), \\\"Invalid operator\\\");\\n        gameOperators[operator] = allowed;\\n        emit GameOperatorUpdated(operator, allowed);\\n    }\\n\\n    function setRewardPerUnit(uint256 newRewardPerUnit) external onlyOwner {\\n        require(newRewardPerUnit > 0, \\\"Invalid reward value\\\");\\n        uint256 oldValue = rewardPerUnit;\\n        rewardPerUnit = newRewardPerUnit;\\n        emit RewardPerUnitUpdated(oldValue, newRewardPerUnit);\\n    }\\n\\n    function startChallenge() external {\\n        _startChallenge(msg.sender);\\n    }\\n\\n    function startChallengeFor(address player) external onlyOperator {\\n        _startChallenge(player);\\n    }\\n\\n    function recordNpcTalk(address player) external onlyOperator {\\n        require(player != address(0), \\\"Invalid player address\\\");\\n\\n        PlayerState storage state = playerStates[player];\\n\\n        if (_isExpired(state)) {\\n            _resetChallenge(state);\\n        }\\n\\n        require(state.challengeStartedAt != 0, \\\"Challenge not active\\\");\\n        require(!state.completed, \\\"Challenge already complete\\\");\\n        require(state.npcTalks < NPCS_PER_CHALLENGE, \\\"NPC limit reached\\\");\\n\\n        state.npcTalks += 1;\\n        uint256 rewardPoints = state.npcTalks / uint8(NPCS_PER_POINT);\\n\\n        emit NpcTalkRecorded(player, state.npcTalks, rewardPoints);\\n\\n        if (state.npcTalks == NPCS_PER_CHALLENGE) {\\n            state.completed = true;\\n            pendingRewardUnits[player] += 1;\\n            emit ChallengeCompleted(player, pendingRewardUnits[player]);\\n        }\\n    }\\n\\n    function redeemMyRewards() external {\\n        uint256 units = pendingRewardUnits[msg.sender];\\n        require(units > 0, \\\"No pending rewards\\\");\\n\\n        uint256 totalAmount = units * rewardPerUnit;\\n        require(address(this).balance >= totalAmount, \\\"Insufficient balance\\\");\\n\\n        pendingRewardUnits[msg.sender] = 0;\\n        _resetChallenge(playerStates[msg.sender]);\\n\\n        payable(msg.sender).transfer(totalAmount);\\n\\n        emit RewardRedeemed(msg.sender, units, totalAmount);\\n    }\\n\\n    function getPlayerProgress(address player)\\n        external\\n        view\\n        returns (\\n            uint256 challengeStartedAt,\\n            uint256 challengeEndsAt,\\n            uint256 npcTalks,\\n            uint256 rewardPoints,\\n            bool completed,\\n            bool expired,\\n            uint256 claimableUnits\\n        )\\n    {\\n        PlayerState memory state = playerStates[player];\\n        challengeStartedAt = state.challengeStartedAt;\\n        challengeEndsAt = challengeStartedAt == 0 ? 0 : challengeStartedAt + CHALLENGE_WINDOW;\\n        npcTalks = state.npcTalks;\\n        rewardPoints = npcTalks / NPCS_PER_POINT;\\n        completed = state.completed;\\n        expired = _isExpired(state);\\n        claimableUnits = pendingRewardUnits[player];\\n    }\\n\\n    function rewardPlayer(\\n        address player,\\n        uint256 units,\\n        bytes32 rewardId\\n    ) external onlyOwner {\\n        require(player != address(0), \\\"Invalid player address\\\");\\n        require(units > 0, \\\"Units must be greater than 0\\\");\\n        require(!usedRewardIds[rewardId], \\\"Already claimed\\\");\\n\\n        uint256 totalAmount = units * rewardPerUnit;\\n        require(address(this).balance >= totalAmount, \\\"Insufficient balance\\\");\\r\\n\\r\\n        usedRewardIds[rewardId] = true;\\r\\n\\r\\n        payable(player).transfer(totalAmount);\\r\\n\\n        emit RewardSent(player, units, totalAmount, rewardId);\\n    }\\n\\n    function _startChallenge(address player) internal {\\n        require(player != address(0), \\\"Invalid player address\\\");\\n\\n        PlayerState storage state = playerStates[player];\\n\\n        if (state.challengeStartedAt != 0 && !_isExpired(state) && !state.completed) {\\n            revert(\\\"Challenge already active\\\");\\n        }\\n\\n        state.challengeStartedAt = uint64(block.timestamp);\\n        state.npcTalks = 0;\\n        state.completed = false;\\n\\n        emit ChallengeStarted(player, block.timestamp, block.timestamp + CHALLENGE_WINDOW);\\n    }\\n\\n    function _isExpired(PlayerState memory state) internal view returns (bool) {\\n        if (state.challengeStartedAt == 0 || state.completed) {\\n            return false;\\n        }\\n        return block.timestamp > uint256(state.challengeStartedAt) + CHALLENGE_WINDOW;\\n    }\\n\\n    function _resetChallenge(PlayerState storage state) internal {\\n        state.challengeStartedAt = 0;\\n        state.npcTalks = 0;\\n        state.completed = false;\\n    }\\n}\\n\",\"keccak256\":\"0x6790a92c83b8b645d50a9bfaab4f180efa3fb29798a8753618122784a62e698b\",\"license\":\"MIT\"}},\"version\":1}"